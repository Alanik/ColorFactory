@{
	ViewBag.Title = "Color Factory";
}

<div id="mainContainer">
	<div id="leftSideContainer">
		<div style="float: right;">
			<span style="color: white;">points: </span>
			<span id="ammunitionPointsContainer"></span>
		</div>

		<div style="margin-top: 40px;">
			<button id="btnEnterLobby" style="margin-bottom: 20px;">Lobby</button>
			<div id="textDiv" style="color: white;">
				<span>players online: </span><span id="spanPlayersOnline"></span>
			</div>
			<ul id="homePlayersOnlineList"></ul>
		</div>
	</div>

	<div id="playerCanvasContainer" style="position: absolute;">
		<canvas id="playerCanvas" width="50" height="50" />
	</div>

	<div id="mapContainer">
		<canvas id="mapCanvas" width="501" height="501" />
	</div>

	<div>
		<canvas id="effectsCanvas" width="501" height="551" />
	</div>
</div>

<script type="text/javascript">

	////////////////////////////////////////////////////////////////////////////
	//global variables
	////////////////////////////////////////////////////////////////////////////
	var ctx = document.getElementById("mapCanvas").getContext("2d");
	var $mapCanvas = $("#mapCanvas");

	var effectsCtx = document.getElementById("effectsCanvas").getContext("2d");
	var $effectsCanvas = $("#effectsCanvas");

	var playerCtx = document.getElementById("playerCanvas").getContext("2d");
	var playerCanvas = document.getElementById("playerCanvas");

	var $playerCanvasContainer = $("#playerCanvasContainer");

	var mainContainer = document.getElementById("mainContainer");

	var myClientId;
	///////////////////////////////////////////////////////////////////////////// 

	//HUB START/////////////////////////////////////////////////////////////////////////////////////
	$.connection.hub.logging = true;
	$.connection.hub.start().done(function () {
		globalGameConnection = $.connection.game;
		myClientId = $.connection.hub.id;
	}).fail(function () {
		alert("Could not Connect!");
	});
	////////////////////////////////////////////////////////////////////////////////////////////////

	$(function () {
		//Game Canvas related
		initialize();
		playing();
	});

	//$("#lobbyContainer").draggable();
	$("#setPlayerNameModalBox").draggable();
	$("button").button();

	//////////////////////////////////////////////////////////////////////////////
	//lobby functions
	//////////////////////////////////////////////////////////////////////////////

	// Create connection
	var lobbyConnection = $.connection.lobby;
	globalGameConnection = $.connection.game;

	lobbyConnection.client.clientReceiveRoomCreated = function (roomName) {
		$('#roomList').append('<li name="' + roomName + '">' + roomName + '<div class="playerCircle circleEmpty"></div><div class="playerCircle circleEmpty"></div><div class="playerCircle circleEmpty"></div><div class="playerCircle circleFullPlayerNotReady"></div></li>');
	};

	$("#btnEnterLobby").click(function () {
		var $lobby = $("#lobbyContainer");
		var winW = $(window).width();
		$lobby.css({ 'left': winW / 2 - $("#lobbyContainer").width() / 2, 'top': 100 });
		lobbyConnection.server.serverBroadcastPlayerEnterLobby();
	});

	lobbyConnection.client.clientReceivePlayerEnterLobby = function (list) {
		$('#roomList').empty();
		$(list).each(function (i, el) {
			$('#roomList').append('<li name="' + el + '">' + el + '<div class="playerCircle circleEmpty"></div><div class="playerCircle circleEmpty"></div><div class="playerCircle circleEmpty"></div><div class="playerCircle circleFullPlayerNotReady"></div></li>');
		});
		$("#lobbyContainer").show();
	}

	$(".btnCloseLobby").click(function () {
		$("#lobbyContainer").hide();
	});

	$("#btnCreateRoom").click(function () {
		var $txt = $("#txtRoomName");
		var roomName = $txt.val().trim();
		if (roomName)
			lobbyConnection.server.serverBroadcastCreateRoom(roomName);
		$txt.val("");
	});

	$("#btnBackToLobby").click(function () {
		$("#lobbyHeaderTitle").text("Lobby");
		$("#roomWrapper").hide();
		$("#lobbyWrapper").show();
	});

	$("#roomList").on("click", "li", function () {
		var theRoom = $(this).attr("name");
		$("#lobbyHeaderTitle").text(theRoom);
		$("#playerListInsideRoom li span").text("").prev().removeClass("circleFullPlayerNotReady").addClass("circleEmpty");
		$("#lobbyWrapper").hide();
		$("#roomWrapper").show();
		lobbyConnection.server.serverBroadcastPlayerEnterRoom(theRoom);
	});

	lobbyConnection.client.clientReceivePlayerEnterRoom = function (playerNamesList) {
		var $span, $circle, $tick, player, seat;

		for (var i = 0; i < playerNamesList.length; i++) {
			player = playerNamesList[i];
			seat = player.SeatNumber;
			$li = $('#playerListInsideRoom li[seatNumber="' + seat.toString() + '"]');
			$span = $li.find("span");
			$circle = $span.prev();

			if (player.Ready === true) {
				$span.css("color", "rgb(10,211,122)");
				$circle.removeClass("circleFullPlayerNotReady circleEmpty").addClass("circleFullPlayerReady");
				$li.find('img').attr('src', '/Images/Lobby/success.png');
			}
			else {
				$span.css("color", "rgb(238,68,68)");
				$circle.removeClass("circleFullPlayerReady circleEmpty").addClass("circleFullPlayerNotReady");
				$li.find('img').attr('src', '/Images/Lobby/successGray.png');
			}

			$span.text(player.Name);

		}
	};

	$(document).on("click", "#playerListInsideRoom .circleEmpty", function () {
		var $theCircle = $(this);
		var theRoom = $("#lobbyHeaderTitle").text();
		var seatNumber = parseInt($theCircle.parent().attr("seatNumber"));
		lobbyConnection.server.serverBroadcastPlayerTakeSeat(theRoom, seatNumber);
	});

	lobbyConnection.client.clientReceivePlayerTakeSeat = function (playerNamesList) {
		var $span, $circle, $tick, player, seat;

		for (var i = 0; i < playerNamesList.length; i++) {
			player = playerNamesList[i];
			seat = player.SeatNumber;
			$li = $('#playerListInsideRoom li[seatNumber="' + seat.toString() + '"]');
			$span = $li.find("span");
			$circle = $span.prev();

			if (player.Ready === true) {
				$span.css("color", "rgb(10,211,122)");
				$circle.removeClass("circleFullPlayerNotReady circleEmpty").addClass("circleFullPlayerReady");
				$li.find('img').attr('src', '/Images/Lobby/success.png');

			}
			else {
				$span.css("color", "rgb(238,68,68)");
				$circle.removeClass("circleFullPlayerReady circleEmpty").addClass("circleFullPlayerNotReady");
				$li.find('img').attr('src', '/Images/Lobby/successGray.png');

			}
			$span.text(player.Name);
	}
	};

	//on player ready click/////////////////////////////////////////////////////////////////////////////////////////////////

	$(document).on("click", "#playerListInsideRoom li img", function () {
		$img = $(this);
		var theRoom = $("#lobbyHeaderTitle").text();
		var seatNumber = parseInt($img.parent().attr("seatNumber"));
		lobbyConnection.server.serverBroadcastPlayerIsReady(theRoom, seatNumber);
	});

	lobbyConnection.client.clientReceivePlayerIsReady = function (seatNumber) {
		var $li = $('#playerListInsideRoom li[seatNumber="' + seatNumber.toString() + '"]');
		$li.find('img').attr('src', '/Images/Lobby/success.png').next().removeClass("circleFullPlayerNotReady").addClass("circleFullPlayerReady").next().css("color", "rgb(10,211,122);");
	};

	lobbyConnection.client.clientReceivePlayerIsNotReady = function (seatNumber) {
		var $li = $('#playerListInsideRoom li[seatNumber="' + seatNumber.toString() + '"]');
		$li.find('img').attr('src', '/Images/Lobby/successGray.png').next().removeClass("circleFullPlayerReady").addClass("circleFullPlayerNotReady").next().css("color", "rgb(238,68,68);");
	};

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//start game, begin in Lobby Hub then communicate to Game Hub throughout the game
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	lobbyConnection.client.initializePlayers = function (name) {
		console.log("invoking server broadcast start game in Game hub");
		globalGameConnection.server.serverBroadcastStartGameFromGameHub(name);
	}
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//ERROR messages
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	lobbyConnection.client.clientReceivePlayerEnterRoomErrorPlayerAlreadyInARoom = function () {
		alert("You already took a seat in a room. You need to leave the room you are sitting at in order to sit down here.");
	}

	lobbyConnection.client.clientReceivePlayerCreateRoomErrorPlayerIsAlreadyAdmin = function () {
		alert("You are already an admin of a room. You need to leave your room in order to create a new one.");
	}

	lobbyConnection.client.clientReceiveSpecifiedRoomDoesNotExist = function (roomName) {
		alert("Game room: " + roomName + " does not exist.")
	};

	////////////////////////////////////////////////////////////////////////////////////////////////////
	//Home Functions
	////////////////////////////////////////////////////////////////////////////////////////////////////

	// Create connection

	$("#btnEnterPlayerName").click(function () {
		var playerName = $("#txtPlayerName").val();
		var player = { name: playerName, id: myClientId };
		lobbyConnection.server.serverBroadcastAddPlayerToPlayerCollection(player);
		$("#setPlayerNameModalBox").hide();
		$(".leftWrapper1").animate({ left: '+=100%', width: '-=100%' }, 2000);
		$(".leftWrapper2").animate({ left: '+=100%', width: '-=100%' }, 2000);
		$(".rightWrapper1").animate({ right: '+=100%' }, 2000);
		$(".rightWrapper2").animate({ right: '+=100%' }, 2000);
		
	});

	lobbyConnection.client.clientReceiveOnDisconnect = function (name, count) {
		var $list = $("#homePlayersOnlineList");
		var $node = $list.find("li:contains(" + name + ")");
		$($node).remove();
		$('#spanPlayersOnline').html(count);
	};

	lobbyConnection.client.clientReceiveMessage = function (count, name) {
		if (typeof name === "string") {
			$("#homePlayersOnlineList").append("<li>" + name + "</li>");
		}
		else {
			for (var i = 0; i < name.length; i++) {
				$("#homePlayersOnlineList").append("<li>" + name[i] + "</li>");
			}
		}
		$('#spanPlayersOnline').html(count);
	};

	lobbyConnection.client.clientReceivePlayerLeaveSeat = function (roomName, seatNumber) {
		if ($("#lobbyHeaderTitle").text() == roomName) {
			var $li = $('#playerListInsideRoom li[seatNumber="' + seatNumber.toString() + '"]');
			var $circle = $li.find(".playerCircleInsideRoom").removeClass("circleFullPlayerNotReady").addClass("circleEmpty");
			$circle.next().css("color", "rgb(238,68,68)").text("");
			$circle.prev().attr("src", "/Images/Lobby/successGray.png");
		}
	};

	lobbyConnection.client.clientReceiveAdminLeaveSeat = function (roomName) {
		alert("Admin has left your room. Game room: " + roomName + " is now closed so please find another room.");
		$('#roomList li[name="' + roomName + '"]').remove();
		if ($("#lobbyHeaderTitle").text() == roomName) {
			$("#lobbyHeaderTitle").text("Lobby")
			$("#roomWrapper").hide();
			$("#lobbyWrapper").show();
		}
	};

</script>
<script src="~/Scripts/functions.js" type="text/javascript"></script>